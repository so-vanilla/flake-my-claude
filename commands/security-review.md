# /security-review - セキュリティ監査

コードのセキュリティ問題を検出し、重大度レベル別に報告する。

**重要: このコマンドは読み取り専用。ファイルの作成・変更・削除は一切行わない。**

## 引数

$ARGUMENTS: 監査対象（省略時はステージされた変更、`all`で全コードベース）

## 処理フロー

以下のステップを順に実行し、結果をまとめて報告する。

### 1. 監査対象の決定

- $ARGUMENTSが `all` の場合: プロジェクト全体を対象
- $ARGUMENTSがファイル/ディレクトリパスの場合: その対象のみ
- $ARGUMENTSが省略された場合: `git diff --cached` でステージされた変更を対象
  - ステージされた変更がなければ `git diff` で未ステージの変更を対象
  - 変更がなければ「監査対象の変更がありません。`all`を指定するとプロジェクト全体を監査します」と案内

### 2. ハードコードされた秘密情報の検出

以下のパターンを検索:
- APIキー/トークン: `api[_-]?key`, `token`, `secret`, `password` を含む文字列リテラル
- AWSキー: `AKIA[0-9A-Z]{16}` パターン
- 秘密鍵: `-----BEGIN.*PRIVATE KEY-----`
- 接続文字列: `mysql://`, `postgres://`, `mongodb://` にパスワードが含まれるもの
- Base64エンコードされた長い文字列で値が直接代入されているもの

### 3. インジェクション脆弱性の検出

- **SQLインジェクション**: 文字列連結/テンプレートでSQL文を構築している箇所
- **コマンドインジェクション**: `os.system()`, `subprocess.run(shell=True)`, バッククォート実行、`exec()` 等
- **XSS**: `innerHTML`, `dangerouslySetInnerHTML`, テンプレートでの非エスケープ出力
- **パストラバーサル**: ユーザー入力をファイルパスに直接使用

### 4. デシリアライゼーションの検出

- `pickle.loads`, `yaml.load`（SafeLoaderなし）、`eval()`, `JSON.parse`（バリデーションなし）
- 信頼できないソースからの入力に対するデシリアライゼーション

### 5. エラーハンドリングの検出

- スタックトレースやデバッグ情報がユーザーに露出する可能性
- 機密情報（DB接続文字列、内部パス等）がエラーメッセージに含まれる可能性
- 空のcatchブロック/エラー無視

### 6. Nix固有のチェック

Nixファイルが存在する場合:
- `builtins.fetchurl` / `builtins.fetchTarball` のハッシュなし使用
- `flake.nix` のinputにrevやhashが固定されていないもの
- `allowUnfree = true` の設定

### 7. 依存関係の確認

利用可能な場合:
- `npm audit` / `cargo audit` / `pip-audit` 等の脆弱性スキャンの実行を提案
- 既知の脆弱性のあるパッケージバージョンの使用を検出

### 8. 報告

以下の形式で結果を報告する:

```
## セキュリティ監査結果

### Critical
<該当なし、または検出された問題>

### High
<該当なし、または検出された問題>

### Medium
<該当なし、または検出された問題>

### Low
<該当なし、または検出された問題>

## 問題詳細
<各問題について:>
- ファイル: <パス:行番号>
- 問題: <説明>
- リスク: <影響の説明>
- 修正提案: <具体的な修正方法>

## 推奨アクション
<優先度順の対応リスト>
```

問題が検出されなかった場合は「セキュリティ上の問題は検出されませんでした」と報告する。
